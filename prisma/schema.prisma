// ğŸš€ NIHONGO-AI èªè¨¼ãƒ»èª²é‡‘ã‚·ã‚¹ãƒ†ãƒ  Prismaã‚¹ã‚­ãƒ¼ãƒ
// ä½œæˆæ—¥: 2025-07-11
// èª¬æ˜: NextAuth.js v5 + Stripeçµ±åˆå¯¾å¿œã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ==========================================
// NextAuth.js v5 æ¨™æº–ãƒ†ãƒ¼ãƒ–ãƒ«
// ==========================================

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model User {
  // ==========================================
  // NextAuth.jsæ¨™æº–ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆèªè¨¼æ™‚ã«è‡ªå‹•åé›†ï¼‰
  // ==========================================
  id                   String   @id @default(cuid())              // è‡ªå‹•ç”Ÿæˆ
  name                 String?                                      // ã€Authã€‘OAuthãƒ»æ‰‹å‹•ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—æ™‚
  email                String   @unique                            // ã€Authã€‘OAuthãƒ»æ‰‹å‹•ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—æ™‚
  emailVerified        DateTime? @map("email_verified")            // ã€Authã€‘ãƒ¡ãƒ¼ãƒ«èªè¨¼æ™‚
  image                String?                                      // ã€Authã€‘OAuthæ™‚ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ
  password             String?                                      // ã€Authã€‘æ‰‹å‹•ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—æ™‚ï¼ˆãƒãƒƒã‚·ãƒ¥åŒ–ï¼‰
  createdAt            DateTime @default(now()) @map("created_at") // è‡ªå‹•ç”Ÿæˆ
  updatedAt            DateTime @updatedAt @map("updated_at")      // è‡ªå‹•æ›´æ–°

  // ==========================================
  // åŸºæœ¬ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ï¼ˆDashboardåé›†ï¼‰
  // ==========================================
  age                  Int?                                        // ã€Dashboardã€‘ä»»æ„å…¥åŠ›
  gender               Gender?                                     // ã€Dashboardã€‘ä»»æ„é¸æŠ
  organization         String?                                     // ã€Dashboardã€‘ä»»æ„å…¥åŠ›ï¼ˆä¼šç¤¾ãƒ»å­¦æ ¡åï¼‰
  occupation           String?                                     // ã€Dashboardã€‘ä»»æ„å…¥åŠ›ï¼ˆè·æ¥­ï¼‰
  location             String?                                     // ã€Dashboardã€‘æ‰‹å‹•é¸æŠ + IPè‡ªå‹•æ¤œå‡ºè£œåŠ©
  timezone             String?                                     // ã€Systemã€‘ãƒ–ãƒ©ã‚¦ã‚¶è‡ªå‹•æ¤œå‡º
  
  // ==========================================
  // è¨€èªãƒ»æ•™è‚²æƒ…å ±ï¼ˆDashboardåé›† - å„ªå…ˆåº¦é«˜ï¼‰
  // ==========================================
  japanese_language_level Int?                                    // ã€Dashboardã€‘å¿…é ˆé¸æŠ 1-6 (N5ã€œãƒã‚¤ãƒ†ã‚£ãƒ–)
  is_educator            Boolean?                                 // ã€Dashboardã€‘å¿…é ˆYes/No
  educate_experience     Int?                                     // ã€Dashboardã€‘æ•™è‚²è€…ã®å ´åˆã®å¹´æ•°
  native_language        String?                                  // ã€Dashboardã€‘é¸æŠå¼
  available_languages    String[]                                 // ã€Dashboardã€‘è¤‡æ•°é¸æŠ
  
  // ==========================================
  // å­¦ç¿’ãƒ»åˆ©ç”¨ç›®çš„ï¼ˆDashboardåé›† - å„ªå…ˆåº¦é«˜ï¼‰
  // ==========================================
  learningGoals        String[]                                   // ã€Dashboardã€‘è¤‡æ•°é¸æŠï¼ˆå­¦ç¿’ç›®æ¨™ï¼‰
  preferredLanguage    String   @default("ja")                   // ã€Systemã€‘åˆæœŸå€¤"ja"ã€è¨­å®šã§å¤‰æ›´å¯
  
  // ==========================================
  // ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°å±æ€§ï¼ˆDashboardåé›† - å„ªå…ˆåº¦é«˜ï¼‰
  // ==========================================
  role                   String?                                  // ã€Dashboardã€‘å¿…é ˆé¸æŠï¼šteacher/learner/school/engineer/researcher/other
  experience             String?                                  // ã€Dashboardã€‘é¸æŠï¼šbeginner/1-3years/3-10years/10years+
  region                 String?                                  // ã€Dashboardã€‘æ‰‹å‹•ç¢ºèª + IPè‡ªå‹•æ¤œå‡º
  
  // ==========================================
  // èˆˆå‘³ãƒ»ãƒ‹ãƒ¼ã‚ºï¼ˆDashboardåé›† - å„ªå…ˆåº¦é«˜ï¼‰
  // ==========================================
  interests              String[]                                 // ã€Dashboardã€‘è¤‡æ•°é¸æŠï¼šai_article/material_creation/translation/community
  pain_points            String[]                                 // ã€Dashboardã€‘ä»»æ„è¤‡æ•°é¸æŠï¼ˆç¾åœ¨ã®èª²é¡Œï¼‰
  goals                  String[]                                 // ã€Dashboardã€‘è¤‡æ•°é¸æŠï¼ˆé”æˆã—ãŸã„ç›®æ¨™ï¼‰
  
  // ==========================================
  // è¡Œå‹•ãƒ‡ãƒ¼ã‚¿ï¼ˆSystemè‡ªå‹•åé›†ï¼‰
  // ==========================================
  device_type            String?                                  // ã€Systemã€‘User-Agentè‡ªå‹•æ¤œå‡º
  access_pattern         String?                                  // ã€Systemã€‘ãƒ­ã‚°ã‚¤ãƒ³é »åº¦ã‹ã‚‰è‡ªå‹•ç®—å‡º
  
  // ==========================================
  // å•†ç”¨åˆ†æï¼ˆDashboardåé›† - å„ªå…ˆåº¦é«˜ï¼‰
  // ==========================================
  budget_range           String?                                  // ã€Dashboardã€‘å¿…é ˆé¸æŠï¼šfree_only/up_to_3000/up_to_10000/over_10000
  decision_maker         Boolean?                                 // ã€Dashboardã€‘Yes/Noï¼ˆè³¼å…¥æ±ºå®šæ¨©ï¼‰
  
  // ==========================================
  // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å®Œæˆåº¦ç®¡ç†ï¼ˆSystemè‡ªå‹•è¨ˆç®—ï¼‰
  // ==========================================
  profile_completion     Int                      @default(20)  // ã€Systemã€‘è‡ªå‹•è¨ˆç®—ï¼š20%(Auth) -> 100%(å…¨é …ç›®å®Œäº†)
  profile_last_updated   DateTime?                              // ã€Systemã€‘ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°æ™‚ã®è‡ªå‹•è¨˜éŒ²
  
  // ==========================================
  // ä½¿ç”¨çŠ¶æ³è¿½è·¡ï¼ˆSystemè‡ªå‹•åé›†ï¼‰
  // ==========================================
  lastLoginAt          DateTime? @map("last_login_at")          // ã€Systemã€‘ãƒ­ã‚°ã‚¤ãƒ³æ™‚è‡ªå‹•æ›´æ–°
  loginCount           Int      @default(0) @map("login_count") // ã€Systemã€‘ãƒ­ã‚°ã‚¤ãƒ³æ™‚è‡ªå‹•ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
  
  // ==========================================
  // Stripeèª²é‡‘æƒ…å ±ï¼ˆSystemè‡ªå‹•ç®¡ç†ï¼‰
  // ==========================================
  stripeCustomerId     String?   @unique @map("stripe_customer_id")     // ã€Systemã€‘Stripeé€£æºæ™‚è‡ªå‹•è¨­å®š
  stripeSubscriptionId String?   @unique @map("stripe_subscription_id") // ã€Systemã€‘ã‚µãƒ–ã‚¹ã‚¯é–‹å§‹æ™‚è‡ªå‹•è¨­å®š
  currentPlan          Plan      @default(FREE) @map("current_plan")    // ã€Systemã€‘ãƒ—ãƒ©ãƒ³å¤‰æ›´æ™‚è‡ªå‹•æ›´æ–°
  subscriptionStatus   SubscriptionStatus? @map("subscription_status") // ã€Systemã€‘Stripe Webhookè‡ªå‹•æ›´æ–°
  billingCycle         BillingCycle? @map("billing_cycle")              // ã€Systemã€‘ãƒ—ãƒ©ãƒ³é¸æŠæ™‚è¨­å®š
  subscriptionEndsAt   DateTime? @map("subscription_ends_at")           // ã€Systemã€‘ã‚µãƒ–ã‚¹ã‚¯ç®¡ç†è‡ªå‹•è¨ˆç®—
  trialEndsAt          DateTime? @map("trial_ends_at")                  // ã€Systemã€‘ãƒˆãƒ©ã‚¤ã‚¢ãƒ«é–‹å§‹æ™‚è‡ªå‹•è¨­å®š

  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  accounts         Account[]
  sessions         Session[]
  languageSkills   LanguageSkill[]
  socialAccounts   SocialAccount[]
  billingHistory   BillingHistory[]
  planChangeHistory PlanChangeHistory[]
  experimentTracking ExperimentTracking[]

  @@map("users")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verificationtokens")
}

// ==========================================
// ã‚«ã‚¹ã‚¿ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«
// ==========================================

// è¨€èªã‚¹ã‚­ãƒ«ï¼ˆ5æ®µéšè©•ä¾¡ï¼‰
model LanguageSkill {
  id                String @id @default(cuid())
  userId            String @map("user_id")
  language          String // 'japanese', 'english', 'chinese', etc.
  skillType         String // 'speaking', 'listening', 'reading', 'writing'
  level             Int    // 1-5ã®ãƒ¬ãƒ™ãƒ«
  selfAssessment    String? // è‡ªå·±è©•ä¾¡ã‚³ãƒ¡ãƒ³ãƒˆ
  lastAssessedAt    DateTime @default(now()) @map("last_assessed_at")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, language, skillType])
  @@map("language_skills")
}

// ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆé€£æºæƒ…å ±
model SocialAccount {
  id                String @id @default(cuid())
  userId            String @map("user_id")
  provider          Provider
  providerId        String @map("provider_id")
  providerUsername  String? @map("provider_username")
  profileUrl        String? @map("profile_url")
  connectedAt       DateTime @default(now()) @map("connected_at")
  lastSyncedAt      DateTime? @map("last_synced_at")
  isActive          Boolean @default(true) @map("is_active")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@unique([provider, providerId])
  @@map("social_accounts")
}

// ==========================================
// èª²é‡‘ãƒ»æ”¯æ‰•ã„é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«
// ==========================================

// èª²é‡‘å±¥æ­´ï¼ˆåˆ†æãƒ»ã‚µãƒãƒ¼ãƒˆç”¨ï¼‰
model BillingHistory {
  id                        String @id @default(cuid())
  userId                    String @map("user_id")
  stripePaymentIntentId     String? @map("stripe_payment_intent_id")
  stripeInvoiceId           String? @map("stripe_invoice_id")
  amount                    Int    // ã‚»ãƒ³ãƒˆå˜ä½
  currency                  String @default("jpy")
  plan                      Plan
  billingCycle              BillingCycle?
  paymentStatus             PaymentStatus
  paymentMethod             String? // 'card', 'bank_transfer', etc.
  failureReason             String? @map("failure_reason")
  paidAt                    DateTime? @map("paid_at")
  createdAt                 DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("billing_history")
}

// ãƒ—ãƒ©ãƒ³å¤‰æ›´å±¥æ­´ï¼ˆãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°åˆ†æç”¨ï¼‰
model PlanChangeHistory {
  id                    String @id @default(cuid())
  userId                String @map("user_id")
  fromPlan              Plan? @map("from_plan") // åˆå›ç™»éŒ²æ™‚ã¯null
  toPlan                Plan @map("to_plan")
  changeReason          ChangeReason @map("change_reason")
  changeTrigger         ChangeTrigger @map("change_trigger")
  effectiveDate         DateTime @map("effective_date")
  createdAt             DateTime @default(now()) @map("created_at")

  // ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°åˆ†æç”¨
  campaignSource        String? @map("campaign_source") // UTMãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
  discountApplied       String? @map("discount_applied") // é©ç”¨ã•ã‚ŒãŸã‚¯ãƒ¼ãƒãƒ³
  customerLifetimeValue Decimal? @map("customer_lifetime_value") // CLVè¨ˆç®—ç”¨

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("plan_change_history")
}

// A/Bãƒ†ã‚¹ãƒˆãƒ»å®Ÿé¨“è¿½è·¡
model ExperimentTracking {
  id                String @id @default(cuid())
  userId            String @map("user_id")
  experimentName    String @map("experiment_name") // 'pricing_page_v2', 'onboarding_flow_a'
  variant           String // 'control', 'treatment_a', 'treatment_b'
  assignedAt        DateTime @default(now()) @map("assigned_at")
  convertedAt       DateTime? @map("converted_at")
  conversionValue   Decimal? @map("conversion_value") // åç›Šã¸ã®å½±éŸ¿
  metadata          Json? // å®Ÿé¨“å›ºæœ‰ã®ãƒ‡ãƒ¼ã‚¿

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, experimentName])
  @@map("experiment_tracking")
}

// ==========================================
// Enumå®šç¾©
// ==========================================

enum Gender {
  MALE
  FEMALE
  NON_BINARY
  PREFER_NOT_TO_SAY
}

enum Provider {
  GOOGLE
  LINE
  INSTAGRAM
}

enum Plan {
  FREE
  BASIC
  PREMIUM
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
  INCOMPLETE
  INCOMPLETE_EXPIRED
  TRIALING
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  CANCELED
  REFUNDED
}

enum ChangeReason {
  UPGRADE
  DOWNGRADE
  CANCELED
  REACTIVATED
  TRIAL_ENDED
}

enum ChangeTrigger {
  USER_INITIATED
  AUTOMATIC
  ADMIN_ACTION
  EXPERIMENT
  PROMOTION
}
