// ğŸš€ NIHONGO-AI èªè¨¼ãƒ»èª²é‡‘ã‚·ã‚¹ãƒ†ãƒ  Prismaã‚¹ã‚­ãƒ¼ãƒ
// ä½œæˆæ—¥: 2025-07-11
// èª¬æ˜: NextAuth.js v5 + Stripeçµ±åˆå¯¾å¿œã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ==========================================
// NextAuth.js v5 æ¨™æº–ãƒ†ãƒ¼ãƒ–ãƒ«
// ==========================================

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model User {
  id                   String   @id @default(cuid())
  name                 String?
  email                String   @unique
  emailVerified        DateTime? @map("email_verified")
  image                String?
  password             String?  // ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ­ã‚°ã‚¤ãƒ³ã®ã¿ã®å ´åˆnull
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±
  age                  Int?
  gender               Gender?
  organization         String?
  occupation           String?
  location             String?  // åœ°åŸŸï¼ˆå›½ãƒ»éƒ½å¸‚ï¼‰
  timezone             String?  // ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³
  
  // è¨€èªãƒ»æ•™è‚²é–¢é€£æƒ…å ±
  japanese_language_level Int?                    // 1,2,3,4,5,native(6)
  is_educator            Boolean?
  educate_experience     Int?                     // å¹´æ•°
  native_language        String?
  available_languages    String[]                 // JSONé…åˆ—
  
  // æ—¥æœ¬èªå­¦ç¿’é–¢é€£æƒ…å ±
  learningGoals        String[] // å­¦ç¿’ç›®æ¨™ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰
  preferredLanguage    String   @default("ja") // UIè¡¨ç¤ºè¨€èª
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼å±æ€§ï¼ˆãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ç”¨ï¼‰
  role                   String?                  // 'æ—¥æœ¬èªæ•™å¸«' | 'æ—¥æœ¬èªå­¦ç¿’è€…' | 'å­¦æ ¡é–¢ä¿‚è€…' | 'æŠ€è¡“è€…' | 'ç ”ç©¶è€…' | 'ãã®ä»–'
  experience             String?                  // 'åˆå¿ƒè€…' | '1-3å¹´' | '3-10å¹´' | '10å¹´ä»¥ä¸Š'
  region                 String?                  // è‡ªå‹•æ¤œå‡º + æ‰‹å‹•ç¢ºèª
  
  // èˆˆå‘³ãƒ»ãƒ‹ãƒ¼ã‚º
  interests              String[]                 // ['AIè¨˜äº‹ç”Ÿæˆ', 'æ•™æä½œæˆ', 'ç¿»è¨³æ©Ÿèƒ½', 'ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£']
  pain_points            String[]                 // ç¾åœ¨ã®èª²é¡Œ
  goals                  String[]                 // ç›®æ¨™
  
  // è¡Œå‹•ãƒ‡ãƒ¼ã‚¿
  device_type            String?                  // 'mobile' | 'tablet' | 'desktop'
  access_pattern         String?                  // 'daily' | 'weekly' | 'occasional'
  
  // å•†ç”¨åˆ†æ
  budget_range           String?                  // 'ç„¡æ–™ã®ã¿' | 'ã€œ3,000å††' | 'ã€œ10,000å††' | '10,000å††ä»¥ä¸Š'
  decision_maker         Boolean?                 // è³¼å…¥æ±ºå®šæ¨©ã®æœ‰ç„¡
  
  // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å®Œæˆåº¦ç®¡ç†
  profile_completion     Int                      @default(20)  // 20% (åŸºæœ¬æƒ…å ±ã®ã¿)
  profile_last_updated   DateTime?
  
  // ä½¿ç”¨çŠ¶æ³è¿½è·¡
  lastLoginAt          DateTime? @map("last_login_at")
  loginCount           Int      @default(0) @map("login_count")
  
  // Stripeé¡§å®¢æƒ…å ±
  stripeCustomerId     String?   @unique @map("stripe_customer_id")
  stripeSubscriptionId String?   @unique @map("stripe_subscription_id")
  currentPlan          Plan      @default(FREE) @map("current_plan")
  subscriptionStatus   SubscriptionStatus? @map("subscription_status")
  billingCycle         BillingCycle? @map("billing_cycle")
  subscriptionEndsAt   DateTime? @map("subscription_ends_at")
  trialEndsAt          DateTime? @map("trial_ends_at")

  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  accounts         Account[]
  sessions         Session[]
  languageSkills   LanguageSkill[]
  socialAccounts   SocialAccount[]
  billingHistory   BillingHistory[]
  planChangeHistory PlanChangeHistory[]
  experimentTracking ExperimentTracking[]

  @@map("users")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verificationtokens")
}

// ==========================================
// ã‚«ã‚¹ã‚¿ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«
// ==========================================

// è¨€èªã‚¹ã‚­ãƒ«ï¼ˆ5æ®µéšè©•ä¾¡ï¼‰
model LanguageSkill {
  id                String @id @default(cuid())
  userId            String @map("user_id")
  language          String // 'japanese', 'english', 'chinese', etc.
  skillType         String // 'speaking', 'listening', 'reading', 'writing'
  level             Int    // 1-5ã®ãƒ¬ãƒ™ãƒ«
  selfAssessment    String? // è‡ªå·±è©•ä¾¡ã‚³ãƒ¡ãƒ³ãƒˆ
  lastAssessedAt    DateTime @default(now()) @map("last_assessed_at")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, language, skillType])
  @@map("language_skills")
}

// ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆé€£æºæƒ…å ±
model SocialAccount {
  id                String @id @default(cuid())
  userId            String @map("user_id")
  provider          Provider
  providerId        String @map("provider_id")
  providerUsername  String? @map("provider_username")
  profileUrl        String? @map("profile_url")
  connectedAt       DateTime @default(now()) @map("connected_at")
  lastSyncedAt      DateTime? @map("last_synced_at")
  isActive          Boolean @default(true) @map("is_active")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@unique([provider, providerId])
  @@map("social_accounts")
}

// ==========================================
// èª²é‡‘ãƒ»æ”¯æ‰•ã„é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«
// ==========================================

// èª²é‡‘å±¥æ­´ï¼ˆåˆ†æãƒ»ã‚µãƒãƒ¼ãƒˆç”¨ï¼‰
model BillingHistory {
  id                        String @id @default(cuid())
  userId                    String @map("user_id")
  stripePaymentIntentId     String? @map("stripe_payment_intent_id")
  stripeInvoiceId           String? @map("stripe_invoice_id")
  amount                    Int    // ã‚»ãƒ³ãƒˆå˜ä½
  currency                  String @default("jpy")
  plan                      Plan
  billingCycle              BillingCycle?
  paymentStatus             PaymentStatus
  paymentMethod             String? // 'card', 'bank_transfer', etc.
  failureReason             String? @map("failure_reason")
  paidAt                    DateTime? @map("paid_at")
  createdAt                 DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("billing_history")
}

// ãƒ—ãƒ©ãƒ³å¤‰æ›´å±¥æ­´ï¼ˆãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°åˆ†æç”¨ï¼‰
model PlanChangeHistory {
  id                    String @id @default(cuid())
  userId                String @map("user_id")
  fromPlan              Plan? @map("from_plan") // åˆå›ç™»éŒ²æ™‚ã¯null
  toPlan                Plan @map("to_plan")
  changeReason          ChangeReason @map("change_reason")
  changeTrigger         ChangeTrigger @map("change_trigger")
  effectiveDate         DateTime @map("effective_date")
  createdAt             DateTime @default(now()) @map("created_at")

  // ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°åˆ†æç”¨
  campaignSource        String? @map("campaign_source") // UTMãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
  discountApplied       String? @map("discount_applied") // é©ç”¨ã•ã‚ŒãŸã‚¯ãƒ¼ãƒãƒ³
  customerLifetimeValue Decimal? @map("customer_lifetime_value") // CLVè¨ˆç®—ç”¨

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("plan_change_history")
}

// A/Bãƒ†ã‚¹ãƒˆãƒ»å®Ÿé¨“è¿½è·¡
model ExperimentTracking {
  id                String @id @default(cuid())
  userId            String @map("user_id")
  experimentName    String @map("experiment_name") // 'pricing_page_v2', 'onboarding_flow_a'
  variant           String // 'control', 'treatment_a', 'treatment_b'
  assignedAt        DateTime @default(now()) @map("assigned_at")
  convertedAt       DateTime? @map("converted_at")
  conversionValue   Decimal? @map("conversion_value") // åç›Šã¸ã®å½±éŸ¿
  metadata          Json? // å®Ÿé¨“å›ºæœ‰ã®ãƒ‡ãƒ¼ã‚¿

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, experimentName])
  @@map("experiment_tracking")
}

// ==========================================
// Enumå®šç¾©
// ==========================================

enum Gender {
  MALE
  FEMALE
  NON_BINARY
  PREFER_NOT_TO_SAY
}

enum Provider {
  GOOGLE
  LINE
  INSTAGRAM
}

enum Plan {
  FREE
  BASIC
  PREMIUM
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
  INCOMPLETE
  INCOMPLETE_EXPIRED
  TRIALING
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  CANCELED
  REFUNDED
}

enum ChangeReason {
  UPGRADE
  DOWNGRADE
  CANCELED
  REACTIVATED
  TRIAL_ENDED
}

enum ChangeTrigger {
  USER_INITIATED
  AUTOMATIC
  ADMIN_ACTION
  EXPERIMENT
  PROMOTION
}
