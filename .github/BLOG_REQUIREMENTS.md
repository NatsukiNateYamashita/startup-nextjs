# 📝 ブログ機能改修 - 要件定義書

> **プロジェクト**: NIHONGO-AI ブログ機能改修  
> **作成日**: 2025年7月3日  
> **更新日**: 2025年7月3日  
> **ステータス**: Phase 1 完了 ✅ | Phase 2 開始可能 🚀

---

## 🎯 **1. プロジェクト概要**

### 1.1 目的
- **現状**: ハードコーディングされた静的ブログデータ
- **目標**: マークダウンベースの柔軟なブログ管理システム
- **将来**: データベース管理への移行容易性を確保

### 1.2 スコープ
- マークダウンファイルでの記事管理
- 多言語対応ブログシステム
- 高度な検索・フィルタリング機能
- 将来の左右表示機能（翻訳対照表示）
- 10000記事以上を見据えたスケーラブル設計

---

## 🏗️ **2. 技術要件**

### 2.1 アーキテクチャ
```
技術スタック:
├── フロントエンド: Next.js 15.3.0 + TypeScript + Tailwind CSS
├── 国際化: next-intl
├── マークダウン: gray-matter + remark/rehype
├── 検索: Fuse.js (将来的にベクトル検索)
├── 画像最適化: Next.js Image + WebP対応
├── 翻訳自動化: Microsoft Translator API
└── 将来のDB: Supabase (PostgreSQL) + Prisma
```

### 2.2 ファイル構造
```
src/
├── content/
│   └── blog/
│       ├── posts/
│       │   ├── 001-ui-components/
│       │   │   ├── ja.md
│       │   │   ├── en.md
│       │   │   ├── zh-TW.md
│       │   │   ├── zh-CN.md
│       │   │   ├── meta.json
│       │   │   └── images/
│       │   │       ├── hero.jpg
│       │   │       ├── diagram.png
│       │   │       └── captions.json
│       │   └── 002-design-skills/
│       │       ├── ja.md
│       │       ├── en.md
│       │       ├── meta.json
│       │       └── images/
│       └── index.json
├── lib/
│   ├── blog/
│   │   ├── index.ts
│   │   ├── markdown.ts
│   │   ├── search.ts
│   │   └── translation.ts
│   └── cache/
│       └── blog-cache.ts
└── types/
    └── blog.ts
```

### 2.3 データ構造
```typescript
// 基本記事データ
interface BlogPost {
  id: string;
  slug: string;
  title: Record<Locale, string>;
  excerpt: Record<Locale, string>;
  content: Record<Locale, string>;
  author: Author;
  tags: string[];
  publishDate: string;
  heroImage: string;
  images: BlogImage[];
  readingTime: Record<Locale, number>;
  featured: boolean;
  status: 'published';
  seoData: SEOData;
  relatedPosts: string[];
  tableOfContents: Record<Locale, TOCItem[]>;
}

// 左右表示対応データ構造
interface BilingualContent {
  sentences: {
    id: string;
    ja: string;
    [locale: string]: string;
  }[];
  paragraphs: {
    id: string;
    sentences: string[];
  }[];
}

// 画像データ
interface BlogImage {
  filename: string;
  alt: Record<Locale, string>;
  caption: Record<Locale, string>;
  width: number;
  height: number;
  sizes: ResponsiveSize[];
}
```

---

## 🔍 **3. 機能要件**

### 3.1 検索機能
- **検索対象**: タイトル + タグ + 本文内容
- **検索方式**: 完全一致（将来的にベクトル検索対応）
- **検索UI**: ブログ一覧ページ内統合
- **検索結果**: 一致語句・選択タグのハイライト表示
- **フィルタリング**: タグ、日付、著者、言語による絞り込み

### 3.2 画像管理
- **保存場所**: 各記事フォルダ内 (`/images/`)
- **最適化**: Next.js Image コンポーネント使用
- **形式**: WebP対応 + レスポンシブ対応
- **キャプション**: 多言語対応キャプション
- **サイズ制限**: 適切なサイズ制限とリサイズ

### 3.3 翻訳管理
- **翻訳者**: 開発者 + Microsoft Translator API
- **翻訳状態**: 翻訳済み.mdがあれば表示、なければエラーページ
- **翻訳更新**: 原文更新時のAPI自動翻訳
- **翻訳ツール**: `translate_json.py`を改修してMarkdown対応

### 3.4 左右表示機能（今回実装）
- **表示形式**: 左右分割レイアウト
- **ハイライト**: 文単位でのマウスオーバーハイライト
- **データ構造**: 文単位での対応関係データ
- **UI制御**: スクロール同期、対応文強調表示

### 3.5 記事管理
- **記事作成**: 開発者による手動作成
- **下書き機能**: 不要
- **更新履歴**: 不要
- **削除機能**: 不要

---

## 🚀 **4. パフォーマンス要件**

### 4.1 スケーラビリティ
- **想定記事数**: 10000記事以上
- **読み込み方式**: 静的生成（SSG）+ ISR（Incremental Static Regeneration）
- **キャッシュ戦略**: 
  - ビルド時記事インデックス生成
  - Redis/Vercel KV でのクエリキャッシュ
  - CDN配信による画像キャッシュ

### 4.2 UX要件
- **記事一覧**: 無限スクロール
- **関連記事**: 記事詳細ページに表示
- **記事目次**: 長文記事の目次表示
- **読了時間**: 記事の読了時間表示
- **ローディング**: スケルトンローディング

---

## 🌐 **5. 国際化要件**

### 5.1 サポート言語
- **日本語** (ja) - デフォルト
- **英語** (en)
- **繁体中国語** (zh-TW)
- **簡体中国語** (zh-CN)

### 5.2 多言語対応
- **記事内容**: 各言語別 .md ファイル
- **メタデータ**: 共通 meta.json + 言語別タイトル・抜粋
- **画像キャプション**: 言語別対応
- **検索**: 言語別検索結果

---

## 🎨 **6. UI/UX要件**

### 6.1 継承要件
- **レイアウト**: 現在のブログページデザイン完全継承
- **コンポーネント**: 既存コンポーネント形式維持
- **レスポンシブ**: 現在のTailwind CSSベース維持

### 6.2 新機能UI
- **検索バー**: ブログ一覧ページ上部
- **タグフィルター**: 検索バー下部
- **左右表示**: 記事詳細ページでの切り替え機能
- **目次**: 記事詳細ページサイドバー
- **関連記事**: 記事詳細ページ下部

---

## 🔄 **7. 移行戦略**

### 7.1 段階的実装
```
Phase 1: 基盤構築（2週間）
├── マークダウン処理システム
├── 型定義・データ構造
├── 基本的なファイル読み込み
└── 既存データの移行

Phase 2: 検索機能（1週間）
├── 検索インデックス構築
├── 検索UI実装
├── フィルタリング機能
└── ハイライト表示

Phase 3: 画像管理（1週間）
├── 画像最適化システム
├── レスポンシブ対応
├── キャプション多言語対応
└── 画像遅延読み込み

Phase 4: 左右表示（2週間）
├── 文単位データ構造
├── 左右分割UI
├── ハイライト機能
└── スクロール同期

Phase 5: 最適化（1週間）
├── パフォーマンス最適化
├── キャッシュ実装
├── 無限スクロール
└── 関連記事・目次
```

### 7.2 DB移行準備
- **ORM**: Prisma設定
- **データベース**: Supabase (PostgreSQL)
- **移行スクリプト**: マークダウンファイル → DB自動移行
- **並行運用**: マークダウンとDBの並行運用期間

---

## 🎉 **Phase 1 実装完了報告**

### ✅ **完了日**: 2025年7月3日

### 🏆 **実装成果**
| 項目 | 要件 | 実装状況 | 備考 |
|------|------|----------|------|
| **マークダウン対応** | 必須 | ✅ 完了 | gray-matter + remark/rehype |
| **多言語対応** | 必須 | ✅ 完了 | 4言語（ja/en/zh-TW/zh-CN） |
| **動的ルーティング** | 必須 | ✅ 完了 | /blog/[slug] SEO最適化 |
| **記事データ移行** | 必須 | ✅ 完了 | 3記事×4言語=12ファイル |
| **型安全性** | 必須 | ✅ 完了 | next-intl routing統合 |
| **レスポンシブ対応** | 必須 | ✅ 完了 | モバイル・タブレット・デスクトップ |
| **ダークテーマ** | 高優先度 | ✅ 完了 | 完全対応 |
| **画像最適化** | 中優先度 | ✅ 基本対応 | Next.js Image使用 |

### 🚀 **追加実装項目**（計画外の改善）
- **Typography plugin**: 見出し階層の適切な表示
- **カスタムUIボックス**: Author/Newsletter分離
- **背景装飾**: SVGグラフィック追加
- **フォーカス改善**: ダークテーマでのプライマリボーダー

### 📊 **技術指標**
- **ビルド時間**: 2秒
- **型エラー**: 0件
- **ESLintエラー**: 0件
- **First Load JS**: 111kB（最適化済み）

### 🔄 **Phase 2への引き継ぎ事項**
- **関連記事機能**: Phase 5で実装予定（getRelatedPosts関数は準備済み）
- **検索機能**: Phase 2で本格実装
- **画像管理**: Phase 3で高度な最適化
- **左右表示**: Phase 4で翻訳対照表示

---

## 🧪 **8. 技術的課題と解決策**

### 8.1 スケーラビリティ対策
**課題**: 10000記事の処理パフォーマンス
**解決策**:
- ビルド時インデックス生成
- 仮想スクロール実装
- 検索結果のページネーション
- CDN活用による配信最適化

### 8.2 文単位ハイライト
**課題**: 左右表示での文単位対応
**解決策**:
- マークダウンパース時の文単位ID付与
- 形態素解析による文境界検出
- 対応関係データの構造化
- DOM操作による動的ハイライト

### 8.3 翻訳管理
**課題**: 大量記事の翻訳管理
**解決策**:
- `translate_json.py`のMarkdown対応改修
- 翻訳状態管理システム
- 差分翻訳による効率化
- 翻訳品質チェック機能

---

## 📊 **9. 品質要件**

### 9.1 パフォーマンス目標
- **初期表示**: 2秒以内
- **検索応答**: 300ms以内
- **画像読み込み**: 遅延読み込み + WebP最適化
- **バンドルサイズ**: 現在サイズ維持

### 9.2 アクセシビリティ
- **WCAG 2.1 AA準拠**
- **キーボードナビゲーション**
- **スクリーンリーダー対応**
- **多言語読み上げ対応**

### 9.3 SEO要件
- **構造化データ**: Article Schema対応
- **メタタグ**: 動的メタデータ生成
- **サイトマップ**: 自動生成
- **OGP**: 各記事のOGP画像生成

---

## 🔧 **10. 開発・運用要件**

### 10.1 開発環境
- **Next.js 15.3.0**: 最新機能活用
- **TypeScript**: 型安全性確保
- **ESLint/Prettier**: コード品質維持
- **Jest/Testing Library**: テスト実装

### 10.2 運用要件
- **自動デプロイ**: Vercel CI/CD
- **監視**: パフォーマンス・エラー監視
- **バックアップ**: 記事データバックアップ
- **分析**: Google Analytics統合

---

## 📋 **11. 受入条件**

### 11.1 機能受入条件
- [ ] 既存記事のMarkdownファイル化
- [ ] 4言語での正常表示
- [ ] 検索機能の動作確認
- [ ] 画像最適化の動作確認
- [ ] 左右表示機能の動作確認
- [ ] レスポンシブデザイン確認
- [ ] パフォーマンス目標達成

### 11.2 品質受入条件
- [ ] TypeScriptエラー0件
- [ ] ESLintエラー0件
- [ ] ビルド成功
- [ ] 全ページ正常表示
- [ ] アクセシビリティ確認
- [ ] SEO要件確認

---

## 🗓️ **12. マイルストーン**

| フェーズ | 期間 | 主要成果物 | 完了条件 |
|---------|------|----------|----------|
| Phase 1 | 2週間 | 基盤システム | 既存記事のMarkdown化 |
| Phase 2 | 1週間 | 検索機能 | タイトル・タグ・本文検索 |
| Phase 3 | 1週間 | 画像管理 | 最適化・キャプション対応 |
| Phase 4 | 2週間 | 左右表示 | 文単位ハイライト |
| Phase 5 | 1週間 | 最適化 | パフォーマンス目標達成 |

**総開発期間**: 約7週間

---

## 📚 **13. 参考資料**

### 13.1 既存ドキュメント
- [PROJECT_DOCUMENTATION.md](../PROJECT_DOCUMENTATION.md)
- [.copilot-instructions.md](.copilot-instructions.md)

### 13.2 技術参考
- [Next.js 15 Documentation](https://nextjs.org/docs)
- [next-intl Documentation](https://next-intl-docs.vercel.app/)
- [Prisma Documentation](https://www.prisma.io/docs)
- [Supabase Documentation](https://supabase.com/docs)

---

> **📝 次のステップ**: 実装計画策定 → 実装開始 → テスト → デプロイ
> **🔄 更新履歴**: 本ドキュメントは実装進捗に応じて更新予定
